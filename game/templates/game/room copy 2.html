<!DOCTYPE html>
<html>
<head>
    <title>Room {{ room_name }}</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: row;
            height: 100vh;
            margin: 0;
            padding: 0;
        }
        #drawing-section {
            flex: 2;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background-color: #f4f4f4;
        }
        #chat-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            border-left: 1px solid #ddd;
            background-color: #fff;
        }
        #canvas {
            border: 1px solid black;
            background-color: white;
        }
        #chat {
            flex: 1;
            overflow-y: scroll;
            border: 1px solid black;
            margin: 10px;
        }
        #messageInput {
            width: calc(100% - 20px);
            margin: 10px;
        }
        #userCount, #turnMessage, #timer, #word {
            margin: 10px;
        }
        #drawingControls, #guessingControls {
            margin: 10px;
        }
        #drawingControls.hidden, #guessingControls.hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div id="drawing-section">
        <h1>Room {{ room_name }}</h1>
        <button id="startGame">Start Game</button>
        <div id="userCount">Users in room: 0</div>
        <div id="drawer">Waiting for players...</div>
        <div id="timer"></div>
        <div id="word"></div>
        <canvas id="canvas" width="800" height="600"></canvas>
        <div id="drawingControls" class="hidden">
            <p id="turnMessage"></p>
            <p>You are drawing. Please draw the word!</p>
        </div>
        <div id="guessingControls" class="hidden">
            <p id="turnMessage"></p>
            <input type="text" id="guess" placeholder="Enter your guess">
            <button id="sendGuess">Send Guess</button>
        </div>
    </div>
    <div id="chat-section">
        <div id="chat"></div>
        <input type="text" id="messageInput" placeholder="Type a message...">
        <button id="sendMessage">Send</button>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            let userId = localStorage.getItem('user_id');
            let userName = localStorage.getItem('username');

            if (!userId || !userName) {
                userId = "{{ user_id }}";
                userName = "{{ username }}";
                localStorage.setItem('user_id', userId);
                localStorage.setItem('username', userName);
            }

            const roomName = "{{ room_name }}";
            const socket = new WebSocket('ws://' + window.location.host + '/ws/game/' + roomName + '/?userId=' + userId + '&username=' + userName);

            let drawer = null;
            let timer = null;
            let drawingEnabled = false;

            socket.onopen = function() {
                console.log("WebSocket is open now.");
                socket.send(JSON.stringify({
                    'action': 'join',
                    'username': userName,
                    'userId': userId
                }));
            };

            socket.onclose = function() {
                console.log("WebSocket is closed now.");
            };

            socket.onerror = function(error) {
                console.error("WebSocket error:", error);
            };

            socket.onmessage = function(e) {
                const data = JSON.parse(e.data);
                handleSocketMessage(data);
            };

            document.getElementById('startGame').onclick = function() {
                socket.send(JSON.stringify({
                    'action': 'start_game'
                }));
                this.innerText = 'Restart Game';
            };

            document.getElementById('sendGuess').onclick = function() {
                const guess = document.getElementById('guess').value;
                socket.send(JSON.stringify({
                    'action': 'guess',
                    'guess': guess,
                    'username': userName,
                    'userId': userId
                }));
                document.getElementById('guess').value = '';
            };

            const canvas = document.getElementById('canvas');
            const ctx = canvas.getContext('2d');
            let drawing = false;

            canvas.addEventListener('mousedown', (e) => {
                if (!drawingEnabled) return;
                drawing = true;
                draw(e);
            });

            canvas.addEventListener('mousemove', (e) => {
                if (drawing) draw(e);
            });

            canvas.addEventListener('mouseup', () => {
                if (!drawingEnabled) return;
                drawing = false;
                ctx.beginPath();
                sendDrawingData();
            });

            function draw(e) {
                if (!drawing || !drawingEnabled) return;
                ctx.lineWidth = 5;
                ctx.lineCap = 'round';
                ctx.strokeStyle = 'black';

                ctx.lineTo(e.clientX - canvas.offsetLeft, e.clientY - canvas.offsetTop);
                ctx.stroke();
                ctx.beginPath();
                ctx.moveTo(e.clientX - canvas.offsetLeft, e.clientY - canvas.offsetTop);
            }

            function sendDrawingData() {
                socket.send(JSON.stringify({
                    'action': 'drawing',
                    'drawing': canvas.toDataURL(),
                    'drawer': userId
                }));
            }

            function drawFromData(drawingData) {
                const image = new Image();
                image.onload = function() {
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    ctx.drawImage(image, 0, 0);
                };
                image.src = drawingData;
            }

            function clearCanvas() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
            }

            function clearChat() {
                document.getElementById('chat').innerHTML = '';
            }

            function startTimer(seconds) {
                clearInterval(timer);
                let timeLeft = seconds;
                timer = setInterval(() => {
                    if (timeLeft <= 0) {
                        clearInterval(timer);
                        socket.send(JSON.stringify({
                            'action': 'next_turn'
                        }));
                    } else {
                        timeLeft -= 1;
                        document.getElementById('timer').innerText = `Time left: ${timeLeft}s`;
                    }
                }, 1000);
            }

            function handleSocketMessage(data) {
                switch (data.action) {
                    case 'new_word':
                        document.getElementById('word').innerText = data.word;
                        document.getElementById('turnMessage').innerText = 'It\'s your turn to draw.';
                        document.getElementById('drawer').innerText = 'You are drawing';
                        break;
                    case 'draw':
                        drawFromData(data.drawing);
                        break;
                    case 'correct_guess':
                        updateChat(`<p><strong>${data.username}:</strong> guessed correctly: ${data.guess}</p>`);
                        break;
                    case 'chat_message':
                        updateChat(`<p><strong>${data.username}:</strong> ${data.message}</p>`);
                        break;
                    case 'user_count':
                        document.getElementById('userCount').innerText = `Users in room: ${data.user_count}`;
                        break;
                    case 'turn':
                        drawer = data.drawer;
                        if (drawer !== userId) {
                            document.getElementById('turnMessage').innerText = `It's ${drawer}'s turn to draw.`;
                            document.getElementById('drawer').innerText = `${drawer} is drawing`;
                        }
                        drawingEnabled = (drawer === userId);
                        document.getElementById('drawingControls').classList.toggle('hidden', !drawingEnabled);
                        document.getElementById('guessingControls').classList.toggle('hidden', drawingEnabled);
                        startTimer(60);
                        break;
                    case 'clear_canvas':
                        clearCanvas();
                        clearChat();
                        break;
                    case 'game_end':
                        alert("Game over! Click Start Game to play again.");
                        document.getElementById('startGame').innerText = 'Start Game';
                        break;
                }
            }

            function updateChat(message) {
                const chat = document.getElementById('chat');
                chat.innerHTML += message;
                chat.scrollTop = chat.scrollHeight;
            }
        });
    </script>
</body>
</html>
